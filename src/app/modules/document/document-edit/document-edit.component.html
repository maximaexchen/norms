<div class="loading-indicator" *ngIf="isLoading">
  <p-progressSpinner
    [style]="{ width: '80px', height: '80px' }"
    strokeWidth="5"
    animationDuration=".8s"
  ></p-progressSpinner>
</div>
<div class="row detail-edit-header">
  <div class="col-sm-4">
    <h1 *ngIf="normNumber">{{ normNumber }}</h1>
    <h1 *ngIf="!normNumber" i18n="@@string-new-dataset">
      Datensatz erstellen
    </h1>
  </div>
  <div class="col-sm-8 text-right">
    <app-crud-nav
      [formMode]="formMode"
      [validForm]="normForm.valid"
      [routeNew]="'/document/new'"
      (save)="onSubmit()"
      (add)="onSubmit()"
      (delete)="deleteDocument()"
    ></app-crud-nav>
  </div>
</div>

<form class="form" (ngSubmit)="onSubmit()" #normForm="ngForm">
  <input type="hidden" [(ngModel)]="formMode" name="formMode" />
  <input type="hidden" [(ngModel)]="id" name="_id" />
  <input type="hidden" [(ngModel)]="rev" name="_rev" />
  <p-tabView>
    <p-tabPanel header="Stammdaten">
      <div class="row">
        <div class="col-sm-6">
          <div class="row">
            <div class="col-sm-8">
              <div class="form-group row">
                <label for="normNumber" class="col-sm-6 col-form-label"
                  >Nummer</label
                >
                <div class="col-sm-6">
                  <input
                    type="text"
                    class="form-control"
                    i18n-placeholder
                    placeholder="Nummer"
                    [(ngModel)]="normNumber"
                    name="normNumber"
                    required
                  />
                </div>
              </div>
            </div>
            <div class="col-sm-4">
              <div class="form-group row">
                <label class="col-sm-4 col-form-label">Revision</label>
                <div class="col-sm-8">
                  <input
                    type="text"
                    class="form-control"
                    i18n-placeholder
                    placeholder="Revision"
                    [(ngModel)]="revision"
                    name="revision"
                    required
                  />
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-sm-8">
              <div class="form-group row">
                <label class="col-sm-6 col-form-label">Herausgeber</label>
                <div class="col-sm-6">
                  <select
                    class="form-control"
                    [(ngModel)]="publisherId"
                    name="publisherId"
                  >
                    <option value="">Herausgeber wählen</option>
                    <option
                      *ngFor="let item of publishers"
                      [value]="item._id"
                      [selected]="item._id == publisherId"
                    >
                      {{ item.name }}
                    </option>
                  </select>
                </div>
              </div>
            </div>
            <div class="col-sm-4">
              <div class="form-group row">
                <label class="col-sm-4 col-form-label" for="revisionDate"
                  >Datum</label
                >
                <div class="col-sm-8">
                  <p-calendar
                    [(ngModel)]="revisionDate"
                    [showIcon]="false"
                    [inline]="false"
                    dateFormat="dd.mm.yy"
                    id="revisionDate"
                    name="revisionDate"
                  ></p-calendar>
                </div>
              </div>
            </div>
          </div>
          <div class="form-group row">
            <label class="col-sm-4 col-form-label">Sprache</label>
            <div class="col-sm-8">
              <p-selectButton
                [options]="[
                  {
                    label: 'de',
                    value: 'de'
                  },
                  {
                    label: 'en',
                    value: 'en'
                  },
                  {
                    label: 'fr',
                    value: 'fr'
                  }
                ]"
                name="normLanguage"
                [(ngModel)]="normLanguage"
              ></p-selectButton>
            </div>
          </div>

          <div class="form-group row">
            <label class="col-sm-4 col-form-label">Beschreibung de</label>
            <div class="col-sm-8">
              <textarea
                class="form-control"
                i18n-placeholder
                placeholder="Beschreibung de"
                required
                [(ngModel)]="descriptionDE"
                name="descriptionDE"
              ></textarea>
            </div>
          </div>

          <div class="form-group row">
            <label class="col-sm-4 col-form-label">Beschreibung en</label>
            <div class="col-sm-8">
              <textarea
                class="form-control"
                i18n-placeholder
                placeholder="Beschreibung en"
                [(ngModel)]="descriptionEN"
                name="descriptionEN"
              ></textarea>
            </div>
          </div>

          <div class="form-group row">
            <label class="col-sm-4 col-form-label">Beschreibung fr</label>
            <div class="col-sm-8">
              <textarea
                class="form-control"
                i18n-placeholder
                placeholder="Beschreibung fr"
                [(ngModel)]="descriptionFR"
                name="descriptionFR"
              ></textarea>
            </div>
          </div>

          <div class="form-group row">
            <label class="col-sm-4 col-form-label">Scope</label>
            <div class="col-sm-8">
              <input
                type="text"
                class="form-control"
                i18n-placeholder
                placeholder="Scope"
                [(ngModel)]="scope"
                name="scope"
              />
            </div>
          </div>

          <div class="form-group row document-tags">
            <label class="col-sm-4 col-form-label">Tags</label>
            <div class="col-sm-8">
              <angular2-multiselect
                name="tags"
                [data]="tags"
                [(ngModel)]="selectedTags"
                [settings]="tagDropdownSettings"
                (onSelect)="onItemSelect($event)"
                (onDeSelect)="onItemDeSelect($event)"
                (onSelectAll)="onSelectAll($event)"
                (onDeSelectAll)="onDeSelectAll($event)"
              >
                <c-badge>
                  <ng-template let-item="item">
                    <label class="badge {{ item.tagType }}">{{
                      item.name
                    }}</label>
                  </ng-template>
                </c-badge>
                <c-item>
                  <ng-template let-item="item">
                    <label class="{{ item.tagType }}"> {{ item.name }}</label>
                  </ng-template>
                </c-item>
              </angular2-multiselect>
            </div>
          </div>
        </div>

        <div class="col-sm-6">
          <div class="col-sm-6">
            <div class="form-group row">
              <label class="col-sm-4 col-form-label">Status</label>
              <div class="col-sm-8">
                <p-selectButton
                  [options]="[
                    {
                      label: 'aktiv',
                      value: true
                    },
                    {
                      label: 'gesperrt',
                      value: false
                    }
                  ]"
                  name="active"
                  [(ngModel)]="active"
                ></p-selectButton>
              </div>
            </div>
          </div>

          <hr />

          <div class="form-group row">
            <label class="col-sm-12 col-form-label text-left"
              >Normdatei (PDF upload)</label
            >
            <div class="col-sm-12">
              <p-fileUpload
                [disabled]="normForm.invalid"
                mode="basic"
                name="files"
                (onSelect)="processUpload($event)"
                accept="application/pdf"
                showUploadButton="true"
                showCancelButtonZZ="false"
                chooseLabel="Norm wählen (PDF)"
              ></p-fileUpload>
              <p *ngIf="!normForm.valid">Bitte erst das Formular ausfüllen</p>
            </div>
          </div>

          <hr />

          <p-button
            type="button"
            *ngIf="attachmentName"
            icon="fa fa-download "
            iconPos="left"
            title="{{ attachmentName }}"
            label="{{
              attachmentName.length > 20
                ? (attachmentName | slice: 0:20) + '...'
                : attachmentName
            }}"
            class="attachmentDownload"
            (click)="getDownload(id, attachmentName)"
          ></p-button>

          <hr />

          <p-fieldset
            legend="Revision Historie"
            [toggleable]="true"
            [transitionOptions]="'100ms'"
            [collapsed]="true"
          >
            <div *ngFor="let revDoc of revisionDocuments; let i = index">
              <a
                class="dynamic-link"
                (click)="getDownload(id, revDoc['name'])"
                >{{
                  revDoc['name'].length > 15
                    ? (revDoc['name'] | slice: 0:15) + '...'
                    : revDoc['name']
                }}</a
              ><br />

              Link to the server file
              <a
                *ngIf="revDoc['path']"
                href="{{ revDoc['path'] }}{{ id }}/{{ revDoc['name'] }}"
                target="_blank"
                title="{{ revDoc['name'] }}"
                class="text-left"
                download
                >{{
                  revDoc['name'].length > 15
                    ? (revDoc['name'] | slice: 0:15) + '...'
                    : revDoc['name']
                }}</a
              >
              ({{ revDoc['revisionID'] }})
              <div style="display: inline-block; float: right;">
                {{ revDoc['date'] | date: 'dd.MM.y' }}
              </div>
              <hr *ngIf="i < revisionDocuments.length - 1" />
            </div>
          </p-fieldset>
        </div>
      </div>
    </p-tabPanel>

    <p-tabPanel header="Referenzen">
      Referenzen
    </p-tabPanel>

    <p-tabPanel header="User">
      <div class="row">
        <div class="col-sm-6">
          <div class="form-group row">
            <label class="col-sm-2 col-form-label">Owner</label>
            <div class="col-sm-10">
              <select class="form-control" [(ngModel)]="ownerId" name="ownerId">
                <option value="" selected="selected">Owner wählen</option>
                <option
                  *ngFor="let owner of owners"
                  [value]="owner._id"
                  [selected]="owner._id == ownerId"
                >
                  {{ owner.lastName }}, {{ owner.firstName }}
                </option>
              </select>
            </div>
          </div>
          <div class="form-group row">
            <label class="col-sm-2 col-form-label">Benutzer</label>
            <div class="col-sm-10">
              <angular2-multiselect
                name="users"
                [data]="users"
                [(ngModel)]="selectedUsers"
                [settings]="userDropdownSettings"
                (onSelect)="onItemSelect($event)"
                (onDeSelect)="onItemDeSelect($event)"
                (onSelectAll)="onSelectAll($event)"
                (onDeSelectAll)="onDeSelectAll($event)"
              >
                <c-item>
                  <ng-template let-item="item">
                    <label> {{ item.name }}</label>
                  </ng-template>
                </c-item>
              </angular2-multiselect>
            </div>
          </div>
        </div>
      </div>
    </p-tabPanel>

    <p-tabPanel header="Historie">
      Historie
    </p-tabPanel>
  </p-tabView>
</form>
